---
title: "Airbnb France : R Markdown"
author: "Margot MARCHAIS--MAURICE"
date: "2022-11-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Introduction

This document describes the preparation steps needed to construct the Rshiny app: [Airbnb Database Rstudio](https://www.shinyapps.io/admin/#/application/7532802).

Credits data source: Airbnbinside.com

```{r packages, message=FALSE}
# Import relevant packages
library(dplyr)
library(lubridate) 
library(stringr)
library(ggplot2)
library(tm)  
library(wordcloud)  

setwd("~/Documents/Formation/Github/Airbnb_Database_Rstudio")

#Disable scientific notation
options(scipen=999)
```

## 1. Importing the data

Three French cities are available on Airbnbinside.com: Paris, Lyon and Bordeaux. For each city, 3 datasets are available: 
* Listings: Information about the listings characteristics and the Airbnb hosts
* Reviews: All comments made by guests
* Calendar: The future evolution of the price of each listing (huge file)

For the present case study, I chose to analyze primarily the Listings dataset as it was already very dense and informative. Moreover, the Rshiny app (free version) sets a limit regarding the size of the dataset (maximum threshold : 1 Go) and the heavy calculations. 

```{r pressure, echo = T, results = 'hide'}
string = "~/Documents/Formation/Github/0_Data/"

# Listings data
listings_Paris <- read.csv(paste0(string, "Airbnb_Paris/listings.csv"), encoding="UTF-8")
listings_Bordeaux <- read.csv(paste0(string, "Airbnb_Bordeaux/listings.csv"), encoding="UTF-8")
listings_Lyon <- read.csv(paste0(string, "Airbnb_Lyon/listings.csv"), encoding="UTF-8")

#Reviews data
reviews_Paris <- read.csv(paste0(string, "Airbnb_Paris/reviews.csv"), encoding="UTF-8")
reviews_Bordeaux <- read.csv(paste0(string, "Airbnb_Bordeaux/reviews.csv"), encoding="UTF-8")
reviews_Lyon <- read.csv(paste0(string, "Airbnb_Lyon/reviews.csv"), encoding="UTF-8")

# Add the city in each data source
listings_Paris = listings_Paris %>% mutate(city = 'Paris')
listings_Bordeaux = listings_Bordeaux %>% mutate(city = 'Bordeaux')
listings_Lyon = listings_Lyon %>% mutate(city = 'Lyon')

reviews_Paris = reviews_Paris %>% mutate(city = 'Paris')
reviews_Bordeaux = reviews_Bordeaux %>% mutate(city = 'Bordeaux')
reviews_Lyon = reviews_Lyon %>% mutate(city = 'Lyon')

# Build a centralized dataset for listings and reviews 
listings = rbind(listings_Paris, listings_Bordeaux, listings_Lyon)
reviews = rbind(reviews_Paris, reviews_Bordeaux, reviews_Lyon)

# Remove individual files to free memory
rm(listings_Paris, listings_Bordeaux, listings_Lyon,
   reviews_Paris, reviews_Bordeaux, reviews_Lyon)
gc()
```

## 2. Data cleaning

The listings dataset we created has 76 columns and 83,000+ rows.
It contains information about every listing scraped by Airbnb inside (number of bedrooms, bathrooms, description, neighborhood, number of associated reviews, etc). It has also data about the hosts (name, verified ID, time since he/she joined Airbnb, Superhost status, etc).

```{r}
# Structure of the database "Listings"
str(listings)
```

It appears that some columns in the listings dataset do not have the correct format. In the code below, the format is rectified for several columns.

```{r echo = T, results = 'hide', message=FALSE, warning=FALSE}
# Transform date columns (considered as strings) into date format
listings <-listings %>%
  mutate(host_since = ymd(host_since),
         last_scraped = ymd(last_scraped),
         calendar_last_scraped = ymd(calendar_last_scraped),
         first_review = ymd(first_review),
         last_review = ymd(last_review))

# Tranform percentage columns (considered as strings due to the '%' sign) into floats
listings$host_response_rate <-gsub("%","", listings$host_response_rate)
listings$host_acceptance_rate <-gsub("%","", listings$host_acceptance_rate)
listings$host_response_rate = as.numeric(listings$host_response_rate) /100
listings$host_acceptance_rate = as.numeric(listings$host_acceptance_rate) /100

#Transform price column (considered as string due to the '$' sign) into numeric variable
listings %>% filter(!grepl('$', price)) 
listings$price <- as.numeric(str_sub(listings$price, 2, -2))

# Transform boolean variables (considered as string) into integer flags
listings = listings %>% 
  mutate(instant_bookable = case_when(instant_bookable=='f' ~ 0, instant_bookable=='t' ~ 1),
         has_availability = case_when(has_availability=='f' ~ 0, has_availability=='t' ~ 1),
         host_identity_verified = case_when(host_identity_verified=='f' ~ 0, host_identity_verified=='t' ~ 1),
         host_has_profile_pic = case_when(host_has_profile_pic=='f' ~ 0, host_has_profile_pic=='t' ~ 1),
         host_is_superhost = case_when(host_is_superhost=='f' ~ 0, host_is_superhost=='t' ~ 1),
         )

#Transform strings into factors as they are categorical variables
listings$host_response_time = as.factor(listings$host_response_time)
listings$room_type = as.factor(listings$room_type)
listings$property_type = as.factor(listings$property_type)
listings_table = as.data.frame(table(listings$room_type, listings$property_type))

# Transform IDs into strings
listings$id = as.character(listings$id)
listings$host_id = as.character(listings$host_id)

# Finally, some date cleaning in the Reviews dataset
reviews$date = ymd(reviews$date)
reviews$year = year(reviews$date)

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
